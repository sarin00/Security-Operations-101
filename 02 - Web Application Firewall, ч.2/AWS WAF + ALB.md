## 1. Вступ та задача
Це заняття повторює суть минулого заняття - створення вразливого веб застосунку, налаштування WAF для фільтрації трафіку та попередження атак на веб застосунок. Однак, в цьому занятті ми виконаємо цю задачу на хмарній інфраструктурі AWS з використанням WAF від AWS який є повноцінним сервісом зі своїми нюансами.

## 2. Про AWS WAFv2
AWS WAF працює на 7-му рівні моделі OSI з HTTP та HTTPS трафіком. AWS WAF працює з такими серсівами AWS: CloudFront, Application Load Balancer, API Gateway, AppSync. WAF ACL (про ACL пізніше) прив'язується до конкретного ресурсу з цих сервісів та фільтрує весь трафік що проходить через цей ресурс. Наприклад, в нас може бути кілька Application Load Balancers, до одного з них ми прив'яжемо (асоціюємо) WAF ACL, і всередині цього WAF ACL будуть правила фільтрації трафіку. Спрощена (не реальна) схема такого підключення виглядає так:

![Схема](https://github.com/sarin00/Security-Operations-101/blob/main/99%20-%20%D0%94%D0%BE%D0%B4%D0%B0%D1%82%D0%BA%D0%BE%D0%B2%D1%96%20%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D1%96%D0%B0%D0%BB%D0%B8/WAF1.png)  

## 3. Налаштування ACL та WAF правил
При плануванні правил для фільтрації трафіку та атак які треба врахувати швидко зрозуміло, що один і той самий запит має проходити через велику кількість різних правил. Ці правила неможливо зробити універсальними під будь-яку атаку, бо атаки занадто різні. Щоб спростити керування цими правилами в AWS WAF є таке поняття як ACL. ACL - це сутність яка прив'язується (асоціюється) з конкретним ресурсом типу Application Load Balancer, і вміщує в собі багато WAF правил. Всі правила всередині ACL будуть задіюватись до кожного запиту зробленого на ресурс до якого прив'язано ACL. 

Уявімо собі, що в нас є 2 ALB (Application Load Balancer) та 1 API Gateway які є частиноб однієї системи. Один ALB стоїть перед веб-порталом для клієнтів, 1 ALB стоїть перед веб порталом для адміністраторів, і API Gateway використовується зовнішніми сервісами що комунікують з нашою системою. В такому випадку нам скоріш за все треба 3 різних ACL, по одному на кожен ресурс що в нас є. Всередині кожного ACL будуть правила які підходять саме тому ресурсу який захищає цей ACL. 
Схема наведена нижче:
![ACLs](https://github.com/sarin00/Security-Operations-101/blob/main/99%20-%20%D0%94%D0%BE%D0%B4%D0%B0%D1%82%D0%BA%D0%BE%D0%B2%D1%96%20%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D1%96%D0%B0%D0%BB%D0%B8/WAF2.png)  

Варто знати, що правила можна поєднувати у Rule Groups та перевикористовувати для різних ACL. Також, один ACL можна асоціювати з різними ресурсами, тоді для цих ресурсів будуть діяти однакові правила фільтрації.  

У правилах WAF налаштовуються всі безпосередні перевірки трафіку. Коли запит співпадає з умовою правила WAF, виконується дія. Дією може бути "дозволити", "заблокувати", "підрахунок", чи "вивести капчу". Для всіх новостворених правил варто виконувати підрахунок, а не блокування як дію. Ви ніколи не знаєте, чи випадково заблокуєте легітимні запити новим правилом. Детальніше про налаштування правил, їх умов та дій описано в [документації AWS](https://docs.aws.amazon.com/waf/latest/developerguide/waf-rule-action.html).  

## 4. Завдання
1. Створіть EC2 instance, налаштуйте на ньому juice shop.  
2. Створіть Target Group в який входитиме новостворений EC2 з juice shop.
3. Створіть ALB, додайте до нього новостворений Target Group.
4. Впевніться що Security Group-и для ALB та EC2 налаштовані правильно, що трафік з інтернету потраплятиме до ALB а трафік від ALB потраплятиме до EC2.
5. Створіть WAF ACL і прив'яжіть його до вашого ALB.
6. Протестуйте кілька атак та juice shop.
7. Додайте правила що надано нижче.
8. Протестуйте працездатність цих правил, перевірте статистику запитів на сторінці ACL.
9. Подивіться логи в CloudWatch → Metrics → All → WAFV2.

## 5. Приклади правил WAF
Блокування SQL ін'єкцій  
![SQL](https://github.com/sarin00/Security-Operations-101/blob/main/99%20-%20%D0%94%D0%BE%D0%B4%D0%B0%D1%82%D0%BA%D0%BE%D0%B2%D1%96%20%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D1%96%D0%B0%D0%BB%D0%B8/WAF-SQLrule.png)  
  
Блокування запитів на API ендпоінт без необхідного cookie:  
![token](https://github.com/sarin00/Security-Operations-101/blob/main/99%20-%20%D0%94%D0%BE%D0%B4%D0%B0%D1%82%D0%BA%D0%BE%D0%B2%D1%96%20%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D1%96%D0%B0%D0%BB%D0%B8/WAF-NoSessionTokenrule.png)  

Блокування GET запитів якщо їх кількість перевищує 100 за 5 хвилин:  
![GET](https://github.com/sarin00/Security-Operations-101/blob/main/99%20-%20%D0%94%D0%BE%D0%B4%D0%B0%D1%82%D0%BA%D0%BE%D0%B2%D1%96%20%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D1%96%D0%B0%D0%BB%D0%B8/WAF-TooManyGETrequestsrule.png)  
  

