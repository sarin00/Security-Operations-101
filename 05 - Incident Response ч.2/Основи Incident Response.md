## 1. Вступ
### 1.1 Різниця між інцидентом та подією
Інструменти типу SIEM генерують десятки альортів та логують сотні тисяч записів на день. Різниця між подією та інцидентом критична, бо ці дві речі мають різні рівні пріорітету.  
`Подія, або альорт` - це повідомлення, які вимагають розслідування людиною. Вони можуть бути False Positive (хибне спрацювання, коли активність виявилась легітимною), чи True Positive (активність виявилась і справді шкідливою і альорт переходить у статус інциденту).  
`Інцидент` - це підтверджена шкідлива/небажана активність, які вимагає повноцінної реакції на інцидент.  

### 1.2 Абревіатури та сленг
`IR` - Incident Response  
`DFIR` - Digital Forensics and Incident Response, активність яка включає не просто розслідування інцидентів, а повноцінну цифрову криміналістику. Зазвичай Digital Forensics це дуже затрана активність по часу та вимагає багато знань та досвіду які не просто знайти на ринку праці.
`CIRT (CSIRT)` - Computer Incident Response Team (Cyber Security Incident Response Team)  
`SOC` - Security Operations Center  
`Alert (альорт)` - автоматизоване повідомлення про активність, яка вимагає розслідування. Альорти можуть бути як створені вендорами інстурментів, так і створені вручну аналітиками для пошуку активності яка їх цікавить. Зазвичай ми створюємо альорти шляхом визначення подій чи активностей, які для нас є підозрілими. Ці події мають в якомусь вигляді логуватись та/чи моніторитись, щоб наші інструменти могли автоматично їх задетектувати. Наприклад, наша SIEM система збирає всі логи з компʼютерів з ОС Windows. Ми створюємо альорт для кожного запуску процесу powershell.exe коли parent process є explorer.exe, бо хочемо детектувати кожен раз коли користувач компʼютера запускає powershell.exe. Коли людина запустить powershell, наша SIEM створить альорт і повідомить нас про це.  
`False Positive` - "хибно позитивне" спрацювання, коли створився альорт на легітимну, нормальну активність. Наприклад, альорт про запуск powershell.exe від explorer.exe, коли при розслідуванні виявилось що системний адміністратор запускав powershell щоб перевірити деякі налаштування OS. Це легітимна активність, і альорт закривається як False Positive.  
`True Positive` - альорт, який при розслідуванні виявився шкідливою/небажаною активністю/кібератакою. Такий альорт переходить у статус інциденту.  

### 1.3 Як працює Security Analyst (аналітик з кібербезпеки)
Коли ми говоримо про Incident Response, аналітики працюють так само як і детективи в серіалах. Ми збираємо до купи всю інформацію яка має цінність та відношення до події, ми складаємо пазли у загальну картину про те, що саме сталось і в якому порядку. Ми покладаємось виключно на факти, безсумнівні докази (хеші, IP адреси, доменні імена, цифрові підписи, сигнатури, тощо), а також дуже багато гуглимо.  
Попри мислення як детективи, ми також маємо мислити як зловмисники. Які способи проникнення у нашу мережу ми бачимо, які сліпі зони чи непропатчені, забуті системи ми маємо, які дані нашої компанії є найкритичнішими для нас, які вірогідні цілі для атаки матимуть хакери, тощо.  

### 1.4 Проблеми, які вже вирішіли за вас
Ти не перший і не останній кібербезпечник, якому треба вибудувати IR екосистему у своїй компанії. Замість того щоб вигадувати колесо, варто спиратись на загальноприйняті стандарти, чи фреймворки. Наприклад:  
1. [NIST SP 800-61 Computer Security Incident Handling Guide](https://csrc.nist.gov/pubs/sp/800/61/r2/final)
2. [NIST SP 800-86 Guide to Integrating Forensic Techniques into Incident Response](https://csrc.nist.gov/pubs/sp/800/86/final)

## 2. Incident Response Phases (Етапи Розслідування Інцидентів)
Рослідування інцидентів - це великий і вмісткий процес який складаєтсья з різних етапів, і якість підготовки та виконання цих етапів визначить наскільки ефективно ви зможете детектувати, розслідувати, та зупиняти кібератаки у своїй компанії.  

Є кілька версій цих фаз від різних джерел, але всі вони мають приблизно однакову суть:  
1. Preparation (Підготовка)  
2. Detection and Analysis (Детектування та розслідування події)  
3. Containment (Ізоляція інфекції та зупинення її поширення по мережі)  
4. Eradication (Знищення інфекції, що важче ніж здається)  
5. Recovery (Відновлення нормальної роботи бізнесу)  
6. Lessons learned (Активності після інциденту та покращення IR процесів)

### 2.1 Preparation (Підготовка до інцидентів)
На відміну від всіх нуступних етапів, підготовка це постійні активності, покращення, планування, та навчання, які робляться до інциденту. Це найважливіший етап, бо без нього навіть найкращі аналітики не дадуть гарного результату в росзлідуванні інцидентів.  

Коли станеться інцидент, які інструменти це задетектують, або як саме працівники компанії повідомлять тебе про підозрілу активність? Як саме ти розслідуватимеш цю подію, кому ти повідомиш про інцидент та хто з твоєї компанії буде частиною CSIRT команди? Які інструменти для кожного з етапів IR ти маєш використовувати? Який у вас план дій по відновленню нормальної роботи бізнесу? Чи є у вас бекапи, де вони, та як саме відновитись з цих бекапів? Що робити, якщо вся корпоративна мережа комунікації перестане працювати, чи ти знаєш номери телефонів членів CSIRT? Якщо корпоративні компʼютері стануть недоступними, які компʼютери використовуватимуть аналітики, як ці компʼютери отримають доступ до корпоративної мережі? Таким питанням нема кінця, але відповідати на них - це і є ціль фази підготовки до IR, і саме через це ця фаза постійна і ніколи не закінчується.  

Прогама-мінімум яку варто виконати в цій фазі:  
1. Incident Response Policy. Політика, перевірена та затвердженна менеджментом компанії, має як мінімум описувати ролі та відповідальності різних посад у компанії та їх дії під час інциденту (з кого складається команда CSIRT), формальні визначення понять інциденту та інших термінів для цієї конкретної компанії, план та деталі деталі публічних оголошень про інциденти (особливо коли це вимагається законом чи кмоплаєнсом), як визначати severity інцидентів та пріорітизовувати їх, які KPI вимірювати, шляхи повідомлення кібербезпечників про інциденти для звичайних працівників, та багато іншого. [Приклад Incident Response Policy](https://frsecure.com/incident-response-policy-template/)  
2. Incident Response Plan/Process. Політика є загальним описом того, що компанія та люди мають робити під час інциденту. План та процес - це опис конкретних кроків які треба буде робити під час розслідування. Технічно, деякі комплаєнси розділяють поняття Plan та Process і вимагають обидва документи, але без цих вимог достатньо буде поєднати план та процес в один детальний документ. Процедура має включати в себе такі речі як чеклісти з задачами які треба виконати під час розслідування, форми та їх приклади для опису деталей інциденту, де зберігаються тікети з інцидентом, які SLA по розслідуванню, а також всі інші покрокові процедури пов'язані з розслідуванням інцидентів.
3. Бажано - плейбуки. Детальні покрокові інструкції по розслідуванню конкретних типів інцидентів. Наприклад, для задетектованих шкідливих програм на ОС мають бути одні кроки розслідування, для задетектованої DDoS атаки зовсім інші. Різні типи інцидентів - різні плейбуки.
4. Зробити список інструментів які допомагають у розслідуванні інцидентів, щоб не шукати їх під час критичних ситуацій.
5. Навчити весь персонал у компанії про основні інциденти які можуть статись та як саме вони мають повідомляти CSIRT команду про це.
6. Періодично проінформовувати персонал задіяний в Incident Response про їх відповідальності та дії під час інцидентів (ці деталі мають бути у політиці яку має затвердити менеджмент, щоб потім ніхто не переводив стрілки на вас та не казав що це не їх відповідальність).  
7. Навчити персонал задіяний в CSIRT (кібербезпечників) усім деталям IR Plan/Process/Playbooks, а також навчити їх користуватись всіма необхідними інструментами для IR.
8. Постійно сканувати системи на вразливості та непропатчені компоненти, моніторити операційні системи, мережу, та інфраструктури на аномалії, проводити тренінги по кібербезпеці для звичайних працівників, тощо.  

### 2.2 Detection and Analysis (Детектування та розслідування події)
На цьому етапі всі минулі підготовчі заходи будуть життєво критичними для компанії. Коли детектується інцидент - кібербезпечники мають відпрацьовувати по плейбуках (або як мінімум по плану). Ви маєте зрозуміти що саме сталось, коли це сталось, в яких частинах системи, і **найважливіше: визначити чи це True Positive чи False Positive**. Дуже часто люди помиляються і кажуть що перше що вони будуть робити з альортом - це ізолювати заражений компонент від мережі. Але більшість альортів будуть False Positive, особливо коли IR системи тільки нещодавно створились і ще не відшліфувались. Якщо ізолювати все підряд без реальної на те загрози, дуже швидко колеги з вашої компанії почнуть скаржитись і ваша команда втратить довіру. Якщо подія виявляється інцидентом, необхідно зрозуміти маштаби цього інциденту. Як багато людей/систем заразило, чим саме та як заразило, які конкретні індикатори компрометації наявні, які дані було вкрадено, тощо. На цьому етапі часто доведеться гуглити, і це нормально. 

Інструментів для аналізу дуже багато, ось деякі дуже поширені та безкоштовні інструменти:  
1. [VirusTotal](https://www.virustotal.com/gui/home/upload)
2. [AlienVault](https://otx.alienvault.com/)
3. [AnyRnu](https://app.any.run/)
4. [HybridAnalysis, мій улюблений ресурс для опису дій програм у пісочниці](https://www.hybrid-analysis.com/)
5. [Shodan](https://www.shodan.io/)
6. [Енциклопедія по Windows logs та Event IDs](https://www.ultimatewindowssecurity.com/securitylog/default.aspx)

### 2.3 Containment (Ізоляція інфекції та зупинення її поширення по мережі)
На цьому етапі ваша основна задача - це ізолювати інфекцію від корпоративної мережі, щоб зупинити поширення, та від інтернету, щоб не дати інфекції можливості відправляти дані назад зловмисникам. Методи ізоляції дуже залежать від типу інциденту, і добре якщо є плейбуки. Якщо плейбуків нема, треба мислити раціонально. До яких даних та компонентів інфекція вже дісталась, і до яких даних вона в теорії могла б дістатись? Як на рівні ОС, налаштувань інфраструктури, чи мережевих пристроїв ізолювати систему? Іноді цей етап вимагає збору цифрових доказів для подальшого розслідування, але таке буває не часто. В цьому випадку ви вірогідно робитимете дамп оперативної пам'яті та всіх процесів що запущені, а також зліпок файлової системи інфікованого пристрою. В більшості випадків ізоляція матиме в собі кілька різних дій, найпоширенішими є наступні:  
1. Ізолювати систему (ОС чи контейнер) від мережі. Зазвичай робиться антивірусними програмами, коли антивірус буде єдиним хто залишить доступ до мережі та інтернету.
2. Якщо на інфікованій системі були якісь дані з обліковими записами, тимчасово заблокувати ці облікові записи та змінити їм паролі.
3. Якщо система виконує функції які не можна переривати (наприклад є бекендом застосунку для клієнтів), то підняти альтернативну систему з таким самим функціоналом, та перенаправити весь трафік на нову систему (зазвичай за допомоою зміни DNS запису).  Саме для таких обставин інфраструктура має бути у вигляді IaC, щоб скоротити час підняття та мінімізувати ручні налаштування.  
4. Заблокувати можливість підключатись до корпоративної мережі з інфікованого пристрою (наприклад при викристанні VPN заблокувати інфікованого користувача, його credentials, сертифікати, тощо).
5. Якщо пристрій було викрадено, при можливості надіслати команду віддаленого видалення даних.

### 2.4 Eradication (Знищення інфекції, що важче ніж здається)
В цьому етапі нам потрібно повністю знищити інфекцію та всі її спроби поширення у системі. В цьому випадку найкращий підхід - це "перебздіти". Заразилась ОС чи контейнер - повністю їх видалити підчисту та встановити заново. Ви звісно можете спробувати по логах зрозуміти які саме активності робила інфекція, куди прописувалась та де ховала свої копії, але ці пошуки займуть багато часу і не дадуть гарантії що ви знайшли всі локації інфекції. Краще не ризикувати і все підчищати під 0.  
Заразився мережевий пристрій? Робіть повний ресет, пропатчте його, і тільки потім накатуйте збережені конфігурації (перевіривши що вразливостей в самих конфігураціях нема).  
Заразився контейнер з API сервером? Ізолювати контейнер, підняти новий з таким самим API сервером, перенаправити трафік на новий контейнер і видалити старий повністю.  
Інфекція могла мати доступ до файлів з паролями? Змінити всі паролі та ключі для всіх ресурсів які були у файлі.  
Могли вкрасти дані користувача? Перестворити пароль, підв'язати на використовувати MFA.  

### 2.5 Recovery (Відновлення нормальної роботи бізнесу)
Після видалення зарази необхідно відновити нормальну роботу систем які були інфіковані. Звичайно в ідеальному випадку у вас мають бути бекапи для всіх даних які є критично важливими і які не можна втратити. Чим краще атоматизація систем - тим простіше буде відновлюватись. Для поширених невеликих інцидентів recovery буде відносно простим та інтуітивним. Для більших інцидентів у вас гарантовано будуть досвідчені люди що керуватимуть процесом та роздаватимуть задачі. Після відновлення роботи варто також якийсь час моніторити активність раніше заражених систем щоб впевнитись що інфекція була повністю знищена і не повернулась.  

### 2.6 Lessons learned (Активності після інциденту та покращення IR процесів)
Останінй етап потрібен для постійного покращення та відшліфування процесу IR. Коли ви дістанетесь сюди в реальності, ви інтуітивно розумітимете які саме були проблеми та помилки, що саме могло піти краще. Найпоширенішими помилками є наступні:  
1. Ніхто не знав хто за що відповідальний, всі мотались у паніці та не знали шо робити.  
2. Інцидент помітили запізно, бо працівники не були проінформовані про те як бути пильними та куди повідомляти про аномалії.
3. Стався нетиповий інцидент для якого не було плейбуку, довелось імпровізувати на ходу.
4. Не було зроблено бекапів систем, або бекапи знаходились на тій самій системі з якох робились, відповідно були теж інфікованими.
5. Хмарна інфраструктура, як і застосунки що там працюють, були підняти вручну і без документації. За відсутності IaC девопсам довелось ночами не спати і згадувати як працюють сервіси AWS.
6. Конфігурації мережевих пристроїв не були збережені та забекаплені, інженерам довелось згадувати як налаштувати пристрої CISCO.
7. Не було інструментів з кібербезпеки взагалі, відповідно не було логів з інфікованих систем та нормальної можливості віддаленої ізоляції.
8. Ніхто не налаштовував пінкод для бітлокера, тепер дані з вкраденого комп'ютера можна витягти.
9. Кібербезпечники, задіяні у інциденті, не мали достатніх привілеїв чи можливості їх оперативно отримати щоб ізолювати та знищити інфекцію.
10. CSIRT команда не знала що в них впринципі є план та плейбуки, всі діяли "інтуітивно".
11. Корпоративні системи не мають достатньої документації та інформації про власника, кібербезпечникам доводилось шукати хоч когось хто знається на системі.
12. Критичні активності, такі як видача доступів до деяких компонентів, контролювались та були зав'язані на одній людині. Людина спала чи була у відпустці, ніхто не міг нічого зробити.
13. Люди забули про патчинг, оце був подарунок хакерам.  

## 3. Висновки
IR - це неймовірно цікава активність, яка вимагає тренувань та підготовки. Чи краще підготовка - тим швидше і краще будуть знищені інфекції.  Матеріалу вище має бути достатньо щоб почати розслідувати прості інциденти, але реальні глиюокі знання та розуміння як краще прийдуть тілки з досвідом.  

## 4. Додаткові матеріали та ресурси
1. [Сайт з купою інстурментів, ресурсів, книг, та посилань на інши навчальні ресурси по DFIR](https://www.dfir.training/resources?f=4)  
2. [Incident Response на Linux](https://www.hackingarticles.in/incident-response-linux-cheatsheet/)
3. [13Cubed](https://www.youtube.com/@13Cubed)
4. [SANS курси, платні але є в інеті](https://www.sans.org/digital-forensics-incident-response/?msc=resources-icons)  
